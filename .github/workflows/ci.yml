name: CI

on:
  push:
branches: [main, develop]
  pull_request:
branches: [main, develop]

jobs:
  lint-and-type-check:
runs-on: ubuntu-latest
steps:
  - name: Checkout code
uses: actions/checkout@v4

  - name: Setup Node.js
uses: actions/setup-node@v4
with:
  node-version: '20'
  cache: 'yarn'

  - name: Enable Corepack
run: corepack enable

  - name: Install dependencies
run: yarn install --immutable

  - name: Type check
run: yarn type-check

  - name: Lint
run: yarn lint

  - name: Format check
run: yarn format --check

  build:
runs-on: ubuntu-latest
needs: lint-and-type-check
steps:
  - name: Checkout code
uses: actions/checkout@v4

  - name: Setup Node.js
uses: actions/setup-node@v4
with:
  node-version: '20'
  cache: 'yarn'

  - name: Enable Corepack
run: corepack enable

  - name: Install dependencies
run: yarn install --immutable

  - name: Build packages
run: yarn build

  test-e2e:
runs-on: ubuntu-latest
needs: build
services:
  postgres:
image: supabase/postgres:15.1.0.147
env:
  POSTGRES_PASSWORD: postgres
  POSTGRES_USER: postgres
  POSTGRES_DB: postgres
options: >-
  --health-cmd pg_isready
  --health-interval 10s
  --health-timeout 5s
  --health-retries 5
ports:
  - 5432:5432

steps:
  - name: Checkout code
uses: actions/checkout@v4

  - name: Setup Node.js
uses: actions/setup-node@v4
with:
  node-version: '20'
  cache: 'yarn'

  - name: Enable Corepack
run: corepack enable

  - name: Install dependencies
run: yarn install --immutable

  - name: Setup Supabase CLI
uses: supabase/setup-cli@v1
with:
  version: latest

  - name: Start Supabase local development setup
run: supabase start
env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  - name: Install Playwright browsers
run: npx playwright install --with-deps

  - name: Build application
run: yarn build

  - name: Run Playwright tests
run: yarn test:e2e
env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

  - name: Upload Playwright report
uses: actions/upload-artifact@v4
if: always()
with:
  name: playwright-report
  path: playwright-report/
  retention-days: 30

  - name: Upload test results
uses: actions/upload-artifact@v4
if: always()
with:
  name: test-results
  path: test-results/
  retention-days: 30