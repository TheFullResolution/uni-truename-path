name: E2E Tests

on:
  push:
branches: [main]
  pull_request:
branches: [main]

jobs:
  test:
timeout-minutes: 60
runs-on: ubuntu-latest

services:
  postgres:
image: supabase/postgres:15.1.0.147
env:
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_DB: postgres
ports:
  - 54322:5432
options: >-
  --health-cmd pg_isready
  --health-interval 10s
  --health-timeout 5s
  --health-retries 5

steps:
  - uses: actions/checkout@v4
  
  - name: Setup Node.js
uses: actions/setup-node@v4
with:
  node-version: '20'
  
  - name: Enable Corepack
run: corepack enable

  - name: Install dependencies
run: yarn install --immutable

  - name: Install Playwright Browsers
run: yarn playwright install --with-deps chromium

  - name: Setup Supabase CLI
uses: supabase/setup-cli@v1
with:
  version: latest
  
  - name: Start Supabase local stack
run: |
  supabase start --workdir ./supabase
  supabase db push --workdir ./supabase
env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  
  - name: Generate database types
run: yarn db:types

  - name: Build packages
run: yarn build

  - name: Run Playwright tests
run: yarn test:e2e
env:
  SUPABASE_URL: http://localhost:54321
  SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
  
  - uses: actions/upload-artifact@v4
if: always()
with:
  name: playwright-report
  path: playwright-report/
  retention-days: 30